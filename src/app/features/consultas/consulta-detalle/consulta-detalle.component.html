<div class="max-w-7xl mx-auto p-6">
  <!-- Loading State -->
  <div *ngIf="loading" class="flex items-center justify-center py-12 no-print">
    <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-6 no-print">
    <p class="text-sm text-red-700">{{ error }}</p>
  </div>

  <!-- Consulta Details -->
  <div *ngIf="!loading && consulta" class="no-print">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Consulta Médica</h1>
        <p class="text-gray-600 mt-1">{{ consulta.fechaConsulta | date:'long' }}</p>
      </div>
      <div class="flex items-center space-x-3">
        <span [class]="'px-4 py-2 rounded-full text-sm font-medium ' +
          (consulta.estado === 'COMPLETADA' ? 'bg-green-100 text-green-800' :
           consulta.estado === 'EN_CURSO' ? 'bg-yellow-100 text-yellow-800' :
           'bg-red-100 text-red-800')">
          {{ formatearEstado(consulta.estado) }}
        </span>
        <button (click)="volver()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
          Volver
        </button>
      </div>
    </div>

    <!-- Información del Paciente -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Información del Paciente</h2>
      <div class="grid grid-cols-2 gap-4" *ngIf="consulta.paciente">
        <div>
          <p class="text-sm text-gray-500">Nombre</p>
          <p class="text-base font-medium text-gray-900">{{ consulta.paciente.nombreCompleto }}</p>
        </div>
        <div>
          <p class="text-sm text-gray-500">Teléfono</p>
          <p class="text-base font-medium text-gray-900">{{ consulta.paciente.telefono }}</p>
        </div>
      </div>
    </div>

    <!-- Datos Generales -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Datos Generales</h2>
      <div class="space-y-4">
        <div>
          <p class="text-sm font-medium text-gray-500">Motivo de Consulta</p>
          <p class="text-base text-gray-900">{{ consulta.motivoConsulta }}</p>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-500">Padecimiento Actual</p>
          <p class="text-base text-gray-900 whitespace-pre-wrap">{{ consulta.padecimientoActual }}</p>
        </div>
        <div *ngIf="consulta.antecedentesFamiliares">
          <p class="text-sm font-medium text-gray-500">Antecedentes Familiares</p>
          <p class="text-base text-gray-900 whitespace-pre-wrap">{{ consulta.antecedentesFamiliares }}</p>
        </div>
        <div *ngIf="consulta.antecedentesPersonales">
          <p class="text-sm font-medium text-gray-500">Antecedentes Personales</p>
          <p class="text-base text-gray-900 whitespace-pre-wrap">{{ consulta.antecedentesPersonales }}</p>
        </div>
      </div>
    </div>

    <!-- Signos Vitales -->
    <div *ngIf="consulta.signosVitales" class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Signos Vitales</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div *ngIf="consulta.signosVitales.presionSistolica">
          <p class="text-sm text-gray-500">Presión Arterial</p>
          <p class="text-lg font-medium text-gray-900">
            {{ consulta.signosVitales.presionSistolica }}/{{ consulta.signosVitales.presionDiastolica }} mmHg
          </p>
        </div>
        <div *ngIf="consulta.signosVitales.frecuenciaCardiaca">
          <p class="text-sm text-gray-500">Frecuencia Cardíaca</p>
          <p class="text-lg font-medium text-gray-900">{{ consulta.signosVitales.frecuenciaCardiaca }} lpm</p>
        </div>
        <div *ngIf="consulta.signosVitales.temperatura">
          <p class="text-sm text-gray-500">Temperatura</p>
          <p class="text-lg font-medium text-gray-900">{{ consulta.signosVitales.temperatura }} °C</p>
        </div>
        <div *ngIf="consulta.signosVitales.saturacionOxigeno">
          <p class="text-sm text-gray-500">SpO2</p>
          <p class="text-lg font-medium text-gray-900">{{ consulta.signosVitales.saturacionOxigeno }}%</p>
        </div>
      </div>
    </div>

    <!-- Diagnósticos -->
    <div *ngIf="consulta.diagnosticos && consulta.diagnosticos.length > 0" class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Diagnósticos</h2>
      <div class="space-y-4">
        <div *ngFor="let diag of consulta.diagnosticos" class="border-l-4 border-blue-500 pl-4 py-2">
          <div class="flex items-center justify-between">
            <p class="font-medium text-gray-900">{{ diag.descripcion }}</p>
            <span *ngIf="diag.sugeridoPorIA" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
              IA
            </span>
          </div>
          <p class="text-sm text-gray-600">{{ diag.tipo }} - {{ diag.severidad }}</p>
          <p *ngIf="diag.codigoCIE10" class="text-xs text-gray-500">CIE-10: {{ diag.codigoCIE10 }}</p>
        </div>
      </div>
    </div>

    <!-- Receta -->
    <div *ngIf="consulta.receta" class="bg-white shadow rounded-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-900">Receta Médica</h2>
        <button (click)="imprimirReceta()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          <span class="material-icons-outlined text-sm">print</span>
          Imprimir
        </button>
      </div>

      <div *ngIf="consulta.receta.medicamentos && consulta.receta.medicamentos.length > 0" class="mb-4">
        <h3 class="font-medium text-gray-700 mb-2">Medicamentos</h3>
        <div *ngFor="let med of consulta.receta.medicamentos" class="border-b border-gray-200 py-3 last:border-b-0">
          <p class="font-medium text-gray-900">{{ med.nombre }}</p>
          <p class="text-sm text-gray-600">Dosis: {{ med.dosis }} - Vía: {{ med.via }}</p>
          <p class="text-sm text-gray-600">Frecuencia: {{ med.frecuencia }} por {{ med.duracion }}</p>
          <p *ngIf="med.indicaciones" class="text-sm text-gray-500 italic">{{ med.indicaciones }}</p>
        </div>
      </div>

      <div *ngIf="consulta.receta.indicacionesGenerales" class="mb-4">
        <h3 class="font-medium text-gray-700 mb-2">Indicaciones Generales</h3>
        <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ consulta.receta.indicacionesGenerales }}</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end space-x-3">
      <button
        *ngIf="consulta.estado === EstadoConsulta.EN_CURSO"
        (click)="completarConsulta()"
        class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
        Completar Consulta
      </button>
    </div>
  </div>

  <!-- Versión Imprimible de la Receta (solo visible al imprimir) -->
  <div *ngIf="consulta && consulta.receta" class="print-only" style="display: none;">
    <div class="print-receta">
      <h1>RECETA MÉDICA</h1>

      <div class="paciente-info">
        <p><strong>Paciente:</strong> {{ consulta.paciente?.nombreCompleto }}</p>
        <p><strong>Teléfono:</strong> {{ consulta.paciente?.telefono }}</p>
        <p><strong>Fecha:</strong> {{ consulta.fechaConsulta | date:'fullDate' }}</p>
      </div>

      <h2>Diagnósticos:</h2>
      <div *ngFor="let diag of consulta.diagnosticos" style="margin-bottom: 10px; padding-left: 10px;">
        <p style="margin: 0;"><strong>{{ diag.descripcion }}</strong> <span *ngIf="diag.codigoCIE10">(CIE-10: {{ diag.codigoCIE10 }})</span></p>
        <p style="margin: 0; font-size: 12px;">Tipo: {{ diag.tipo }} | Severidad: {{ diag.severidad }}</p>
      </div>

      <h2>Medicamentos Prescritos:</h2>
      <div *ngFor="let med of consulta.receta.medicamentos; let i = index" class="medicamento-item">
        <p style="margin: 0;"><strong>{{ i + 1 }}. {{ med.nombre }}</strong></p>
        <p style="margin: 5px 0 0 0; font-size: 14px;">
          <strong>Dosis:</strong> {{ med.dosis }}<br>
          <strong>Vía:</strong> {{ med.via }}<br>
          <strong>Frecuencia:</strong> {{ med.frecuencia }}<br>
          <strong>Duración:</strong> {{ med.duracion }}
        </p>
        <p *ngIf="med.indicaciones" style="margin: 5px 0 0 0; font-size: 13px; font-style: italic;">
          {{ med.indicaciones }}
        </p>
      </div>

      <div *ngIf="consulta.receta.indicacionesGenerales" style="margin-top: 20px;">
        <h2>Indicaciones Generales:</h2>
        <p style="white-space: pre-wrap; font-size: 14px;">{{ consulta.receta.indicacionesGenerales }}</p>
      </div>

      <div *ngIf="consulta.receta.recomendaciones" style="margin-top: 15px;">
        <h2>Recomendaciones:</h2>
        <p style="white-space: pre-wrap; font-size: 14px;">{{ consulta.receta.recomendaciones }}</p>
      </div>

      <div class="firma-section">
        <div class="firma-linea"></div>
        <p style="margin: 0; font-size: 14px;">Firma y Sello del Médico</p>
      </div>
    </div>
  </div>
</div>
